# 🧩 معماری سیستم تحلیل رفتار مشتری با دوربین مداربسته

این سند معماری ماژولار سیستم را برای تحلیل سه‌لایه‌ای رفتار مشتریان (خریدار، بازدیدکننده، فرصت‌طلب/دزد) تعریف می‌کند. معماری به‌گونه‌ای طراحی شده است که سیستم به صورت مرحله‌ای توسعه یابد، قابل یادگیری و ارتقاء باشد، و با حداقل منابع قابل اجرا باقی بماند.

---

## 📐 ساختار کلی سیستم

```text
[Input: CCTV Video]
        ↓
[1. Frame Extractor]
        ↓
[2. Feature Extractor]
        ↓
[3. Behavior Classification Modules]
        ├── Enneagram Estimator
        ├── MBTI Estimator
        ├── Body Language Interpreter
        └── Spatial Mapper (Store Layout)
        ↓
[4. Behavior Fusion Engine]
        ↓
[5. Customer Type Classifier]
        └── Output: buyer | browser | thief
        ↓
[6. LLM Explainer (optional)]
        ↓
[7. Feedback & Reward Engine]

=======================================================================================================================================================
🧱 اجزای اصلی سیستم
1. 📥 Frame Extractor
ماژول ابتدایی

وظیفه: استخراج فریم از ویدیو با نرخ مشخص (1fps تا 5fps)

خروجی: مجموعه فریم‌های زمانی

2. 🧠 Feature Extractor
استخراج ویژگی‌های حرکتی، تعاملی، موقعیتی و زبان بدن

خروجی: فایل JSON یا CSV شامل ویژگی‌های سطح مشتری

ورودی: فریم‌ها
خروجی: features/session_001.json

3. 🔍 Behavior Classifier Modules
a) Enneagram Estimator
تحلیل ۹ تیپ شخصیتی بر اساس رفتار (rule-based یا ML)

b) MBTI Estimator
تحلیل ۴ بعد شخصیت (E/I, S/N, T/F, J/P)

c) Body Language Interpreter
تشخیص رفتارهای اضطرابی، دودلی، پنهان‌کاری

d) Spatial Mapper (Store Layout)
نگاشت موقعیت مشتری با نقشه فروشگاه (layout_map.json)

4. 🔀 Fusion Engine
ترکیب خروجی ماژول‌ها (شخصیت + زبان بدن + موقعیت)

وزن‌دهی پویا بر اساس context

محاسبه suspicion_score, confusion_score, intent_to_buy_estimate و سایر شاخص‌های نهایی

5. 🧭 Customer Type Classifier
دسته‌بندی نهایی رفتار به یکی از سه کلاس:

buyer: رفتار خرید واقعی یا مردد

browser: بازدید و تجربه‌گرا

thief: رفتار مشکوک یا پنهان‌کار

6. 🗣️ LLM Explainer (اختیاری)
تولید توضیح متنی انسانی از خروجی مدل

استفاده از prompt + خروجی ویژگی‌ها برای پاسخ‌دهی

مدل‌های پیشنهادی: Mistral, ChatGPT, Phi، Gemma

7. 🧪 Feedback & Reward Engine
مقایسه خروجی سیستم با داده واقعی (ground truth)

ثبت و اصلاح عملکرد ماژول‌ها

یادگیری تدریجی با تغییر وزن یا منطق تصمیم‌گیری

🧮 ذخیره‌سازی داده

| نوع فایل     | مسیر                                  | توضیح               |
| ------------ | ------------------------------------- | ------------------- |
| ویدیو خام    | `data/raw_videos/`                    | ورودی اصلی          |
| فریم‌ها      | `data/extracted_frames/`              | پردازش اولیه        |
| ویژگی‌ها     | `data/features/*.json`                | استخراج‌شده از فریم |
| برچسب‌ها     | `data/labels/*.csv`                   | داده مرجع           |
| پاداش‌ها     | `data/feedback/*.json`                | بازخورد یادگیری     |
| نقشه فروشگاه | `data/store_layout/layout_map.json`   | مختصات و چیدمان     |
| وزن ناحیه‌ها | `data/store_layout/zone_weights.json` | سطح حساسیت هر ناحیه |

🧩 اتصال ماژول‌ها به‌صورت ماژولار
هر بخش مستقل، قابل تست، ارتقاء و جایگزینی است

مدل‌ها می‌توانند rule-based، ML یا hybrid باشند

ماژول‌های آینده مثل سیستم فروش، پیشنهاد کالا، تبلیغات، تحلیل تجربه مشتری قابل الحاق هستند

📌 نتیجه:
معماری طراحی‌شده:

قابل پیاده‌سازی با منابع محدود (بدون GPU)

قابل ارتقاء به LLM و سیستم یادگیری با پاداش

مستقل از نوع فروشگاه (با تغییر فایل نقشه)

قابل تحلیل، بهینه‌سازی و گزارش‌گیری

---

با این فایل، معماری کاملاً شفاف، مستند و توسعه‌پذیر می‌شه.  
اگر تأییدش می‌کنی، بگو تا بریم سراغ `layout_mapping.md` و طراحی ساختار `layout_map.json`.
